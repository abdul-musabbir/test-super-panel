'use client';

import { RiCalendarEventLine } from '@remixicon/react';
import { addDays, format, isToday } from 'date-fns';
import { fi } from 'date-fns/locale';
import { useMemo } from 'react';
import { AgendaDaysToShow } from './constants';
import { EventItem } from './event-item';
import { CalendarEvent } from './types';
import { getAgendaEventsForDay } from './utils';

// import {
//   AgendaDaysToShow,
//   type CalendarEvent,
//   EventItem,
//   getAgendaEventsForDay,
// } from "@/components/event-calendar";

interface AgendaViewProps {
    currentDate: Date;
    events: CalendarEvent[];
    onEventSelect: (event: CalendarEvent) => void;
}

export function AgendaView({
    currentDate,
    events,
    onEventSelect,
}: AgendaViewProps) {
    // Show events for the next days based on constant
    const days = useMemo(() => {
        console.log(
            'Agenda view updating with date:',
            currentDate.toISOString(),
        );
        return Array.from({ length: AgendaDaysToShow }, (_, i) =>
            addDays(new Date(currentDate), i),
        );
    }, [currentDate]);

    const handleEventClick = (event: CalendarEvent, e: React.MouseEvent) => {
        e.stopPropagation();
        console.log('Agenda view event clicked:', event);
        onEventSelect(event);
    };

    // Check if there are any days with events
    const hasEvents = days.some(
        (day) => getAgendaEventsForDay(events, day).length > 0,
    );

    return (
        <div className="border-t border-border/70 px-4">
            {!hasEvents ? (
                <div className="flex min-h-[70svh] flex-col items-center justify-center py-16 text-center">
                    <RiCalendarEventLine
                        className="mb-2 text-muted-foreground/50"
                        size={32}
                    />
                    <h3 className="text-lg font-medium">Ei tapahtumia</h3>
                    <p className="text-muted-foreground">
                        TÃ¤lle ajanjaksolle ei ole aikataulutettu tapahtumia.
                    </p>
                </div>
            ) : (
                days.map((day) => {
                    const dayEvents = getAgendaEventsForDay(events, day);

                    if (dayEvents.length === 0) return null;

                    return (
                        <div
                            className="relative my-12 border-t border-border/70"
                            key={day.toString()}
                        >
                            <span
                                className="absolute -top-3 left-0 flex h-6 items-center bg-background pe-4 text-[10px] uppercase data-today:font-medium sm:pe-4 sm:text-xs"
                                data-today={isToday(day) || undefined}
                            >
                                {(() => {
                                    const weekday = format(day, 'cccc', {
                                        locale: fi,
                                    });
                                    const capitalized =
                                        weekday.charAt(0).toUpperCase() +
                                        weekday.slice(1);
                                    const dayMonth = format(day, 'd MMM', {
                                        locale: fi,
                                    });
                                    return `${dayMonth}, ${capitalized}`;
                                })()}
                            </span>
                            <div className="mt-6 space-y-2">
                                {dayEvents.map((event) => (
                                    <EventItem
                                        event={event}
                                        key={event.id}
                                        onClick={(e) =>
                                            handleEventClick(event, e)
                                        }
                                        view="agenda"
                                    />
                                ))}
                            </div>
                        </div>
                    );
                })
            )}
        </div>
    );
}
